<cdk-virtual-scroll-viewport [itemSize]="48">
  <table mat-table #table [dataSource]="items" [trackBy]="trackByNode" class="mat-elevation-z8">
    <ng-container matColumnDef="activity">
      <th mat-header-cell *matHeaderCellDef>
        <div class="activity-row">
          <span>
            Aktivität ({{ shownActivities }}<span *ngIf="shownActivities !== activities.length">
              /{{activities.length}}</span
            >)
          </span>
          <rolx-start-toggle *ngIf="showToggle"></rolx-start-toggle>
        </div>
      </th>

      <td
        mat-cell
        *matCellDef="let item"
        [attr.colspan]="item ? 1 : 8"
        [class.error]="isActivity(item) && hasInvalidRecord(item)">
        <div class="activity-row">
          <span *ngIf="isActivity(item); else treeNode">
            <ng-container *ngIf="asTreeView; else tableView">
              <rolx-starred-activity-indicator
                *ngIf="isCurrentUser"
                [activity]="item"></rolx-starred-activity-indicator>
              <span>{{item.name}} <small>{{item.fullNumber}}</small> </span>
            </ng-container>
            <ng-template #tableView>
              <rolx-starred-activity-indicator
                *ngIf="isCurrentUser"
                [activity]="item"></rolx-starred-activity-indicator>
              <span>
                <small> {{item.allSubprojectNames}} </small>
                <br />
                {{item.name}} <small>{{item.fullNumber}}</small>
              </span>
            </ng-template>
          </span>

          <ng-template #treeNode>
            <ng-container *ngIf="isTreeNode(item);">
              <span>
                <button
                  class="expand-button"
                  mat-icon-button
                  (click)="toggleExpand(item)"
                  [class.expanded]="item.isExpanded">
                  <mat-icon>expand_more</mat-icon>
                </button>
                <span class="tree-node">{{item.name}} <small>{{item.number}}</small></span>
              </span>
            </ng-container>
          </ng-template>

          <rolx-stop-toggle
            *ngIf="isToggleShownFor(item) && todaysRecord"
            [activity]="item"
            [record]="todaysRecord"
            (changed)="submitToggleRecord($event)">
          </rolx-stop-toggle>
        </div>
      </td>

      <td mat-footer-cell *matFooterCellDef>
        <span *ngIf="shownActivities !== activities.length">
          {{activities.length - shownActivities}} weitere Aktivitäten gefunden.
        </span>
      </td>
    </ng-container>

    <ng-container *ngFor="let weekday of weekdays; let i = index" [matColumnDef]="weekday">
      <th
        mat-header-cell
        *matHeaderCellDef
        class="day-header"
        [class.non-workday]="!records[i].isWorkday && !records[i].isToday"
        [class.today]="records[i].isToday"
        [class.error]="recordIsInvalid[i]">
        <span>
          <mat-icon
            *ngIf="recordIsInvalid[i]"
            [inline]="true"
            matTooltip="Dieser Tag enthält ungültige Werte. Bearbeiten ist erst nach Bereinigung möglich">
            warning
          </mat-icon>
          {{records[i].date.toDate() | date: 'mediumDate'}}
        </span>
        <ng-container *ngIf="records[i].dayName">
          <br />
          <small>{{records[i].dayName}}</small>
        </ng-container>
      </th>

      <td
        mat-cell
        *matCellDef="let item, let row = index"
        class="day"
        [hidden]="!item"
        [class.non-workday]="!records[i].isWorkday && !records[i].isToday"
        [class.today]="records[i].isToday && !recordIsInvalid[i]"
        [class.error]="recordIsInvalid[i]"
        (click)="recordIsInvalid[i] && openInvalidEntryDialog(records[i], i)">
        <rolx-week-table-cell
          *ngIf="isActivity(item); else treeNodeData"
          [row]="row"
          [column]="i"
          [record]="records[i]"
          [activity]="item"
          [user]="user"
          [hideEdit]="recordIsInvalid[i]"
          (changed)="submit($event, i)">
        </rolx-week-table-cell>

        <ng-template #treeNodeData>
          <ng-container *ngIf="isTreeNode(item);">
            <span class="tree-node">{{item.getRecordSumFormatted(records[i])}}</span>
          </ng-container>
        </ng-template>
      </td>

      <td
        mat-footer-cell
        *matFooterCellDef
        class="day"
        [class.non-workday]="!records[i].isWorkday && !records[i].isToday"
        [class.today]="records[i].isToday"
        [class.error]="recordIsInvalid[i]"
        (click)="recordIsInvalid[i] && openInvalidEntryDialog(records[i], i)">
        <rolx-paid-leave-select
          *ngIf="records[i].mayHavePaidLeave && !recordIsInvalid[i]; else overtime"
          [record]="records[i]"
          (changed)="submit($event, i)"></rolx-paid-leave-select>

        <ng-template #overtime>
          <span [matTooltip]="records[i].tooltip" matTooltipPosition="above">
            {{records[i].totalDuration}}
          </span>
        </ng-template>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
    <tr
      mat-row
      *matRowDef="let item; columns: displayedColumns;"
      [class.tree-view]="asTreeView"
      [class.subproject]="isTreeNode(item) && item.parentNumber !== undefined"
      [class.activity]="isActivity(item)"></tr>
    <tr mat-footer-row *matFooterRowDef="displayedColumns; sticky: true"></tr>
  </table>
</cdk-virtual-scroll-viewport>
